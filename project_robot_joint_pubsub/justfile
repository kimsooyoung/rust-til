# Project-local Justfile for `project_robot_joint_pubsub`.
# Goals:
# - Keep MuJoCo-related commands close to the project.
# - Provide explicit, repeatable build/run commands with clear env requirements.
#
# Typical workflow (dev):
#   - just project_robot_joint_pubsub mujoco-build
#   - export MUJOCO_STATIC_LINK_DIR="$(realpath ../mujoco-rs/mujoco/build/lib)"
#   - just project_robot_joint_pubsub run-robot-subscriber
#
# Note: environment variables set in a `just` recipe cannot persist back to your shell.

# Compatibility wrapper:
# If you're already in `project_robot_joint_pubsub/`, you can still run:
#   just project_robot_joint_pubsub <recipe>
# even though this directory has its own `justfile`.
project_robot_joint_pubsub +args:
    @just -f "{{justfile_directory()}}/justfile" {{args}}

# Default recipe: show available commands in this file
default:
    @just --list

# Build MuJoCo (modified) with C++ viewer support.
# This runs the repo-provided script and prints the resulting library directory.
mujoco-build:
    @cd "{{justfile_directory()}}" && bash ./build_mujoco_cpp.sh

# Print the recommended export command for MUJOCO_STATIC_LINK_DIR.
# This is for your shell (zsh/bash), not for `just` itself.
mujoco-export-hint:
    @cd "{{justfile_directory()}}" && \
      echo "Run this in your shell (cannot be persisted by just):" && \
      echo "  export MUJOCO_STATIC_LINK_DIR=\"$(realpath ../mujoco-rs/mujoco/build/lib)\""

# Build binaries (dev profile).
# - `publisher` does not require a system MuJoCo install.
# - `subscriber` requires MUJOCO_STATIC_LINK_DIR for the C++ viewer build.
build:
    @cd "{{justfile_directory()}}" && cargo build

# Build binaries (release profile).
build-release:
    @cd "{{justfile_directory()}}" && cargo build --release

# Run publisher with MUJOCO_DOWNLOAD_DIR set (used by mujoco-rs when auto-download is enabled).
# This keeps downloaded artifacts inside `project_robot_joint_pubsub/mujoco_libs` in dev.
run-robot-publisher:
    @cd "{{justfile_directory()}}" && MUJOCO_DOWNLOAD_DIR="$(realpath mujoco_libs)" cargo run --bin publisher

# Run subscriber with MUJOCO_STATIC_LINK_DIR set (for C++ viewer / libsimulate static linking).
# This avoids the pkg-config lookup for `mujoco.pc`.
run-robot-subscriber:
    @cd "{{justfile_directory()}}" && \
      if [ -z "${MUJOCO_STATIC_LINK_DIR:-}" ]; then \
        echo "❌ Error: MUJOCO_STATIC_LINK_DIR not set."; \
        echo "   1) Run: just project_robot_joint_pubsub mujoco-build"; \
        echo "   2) Then in your shell:"; \
        echo "      export MUJOCO_STATIC_LINK_DIR=\"$(realpath ../mujoco-rs/mujoco/build/lib)\""; \
        exit 1; \
      fi && \
      env MUJOCO_STATIC_LINK_DIR="${MUJOCO_STATIC_LINK_DIR:-}" cargo run --bin subscriber

# Watch publisher (rebuild + run on changes).
watch-robot-publisher:
    @cd "{{justfile_directory()}}" && cargo-watch -qc -x "run --bin publisher" -x clippy

# Watch subscriber (rebuild + run on changes).
watch-robot-subscriber:
    @cd "{{justfile_directory()}}" && \
      if [ -z "${MUJOCO_STATIC_LINK_DIR:-}" ]; then \
        echo "❌ Error: MUJOCO_STATIC_LINK_DIR not set."; \
        echo "   1) Run: just project_robot_joint_pubsub mujoco-build"; \
        echo "   2) Then in your shell:"; \
        echo "      export MUJOCO_STATIC_LINK_DIR=\"$(realpath ../mujoco-rs/mujoco/build/lib)\""; \
        exit 1; \
      fi && \
      env MUJOCO_STATIC_LINK_DIR="${MUJOCO_STATIC_LINK_DIR:-}" cargo-watch -qc -x "run --bin subscriber" -x clippy
